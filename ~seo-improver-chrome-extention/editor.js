// locator-modal-content.js
// \file locator-modal-content.js
// -*- coding: utf-8 -*-

/**
 * Content Script –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –ª–æ–∫–∞—Ç–æ—Ä–æ–≤
 * =======================================================
 * –í–Ω–µ–¥—Ä—è–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞ —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
 */

(function() {
    'use strict';

    // –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ —Å–∫—Ä–∏–ø—Ç —É–∂–µ
    if (window.locatorEditorLoaded) {
        console.log('[Locator Editor] –°–∫—Ä–∏–ø—Ç —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é');
        return;
    }
    window.locatorEditorLoaded = true;

    console.log('[Locator Editor] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è content script...');

    /**
     * –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
     */
    const ModalConfig = {
        currentDomain: null,
        currentConfig: {},
        originalConfig: {},
        activeKey: null,
        isOpen: false
    };

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ HTML —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
     * –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç DOM —ç–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ
     * 
     * Returns:
     *     HTMLElement: Overlay —ç–ª–µ–º–µ–Ω—Ç —Å –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º
     */
    function createModalHTML() {
        console.log('[Locator Editor] –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞...');
        
        // –°–æ–∑–¥–∞–µ–º overlay
        const overlay = document.createElement('div');
        overlay.id = 'locator-editor-overlay';
        
        // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = document.createElement('div');
        modal.id = 'locator-editor-modal';
        
        // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        const header = document.createElement('div');
        header.className = 'locator-modal-header';
        
        const titleDiv = document.createElement('div');
        titleDiv.className = 'locator-modal-title';
        
        const h1 = document.createElement('h1');
        h1.textContent = '‚öôÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä –ª–æ–∫–∞—Ç–æ—Ä–æ–≤';
        
        const h2 = document.createElement('h2');
        h2.id = 'locator-domain-name';
        h2.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        
        titleDiv.appendChild(h1);
        titleDiv.appendChild(h2);
        
        // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'locator-modal-actions';
        
        const saveBtn = createButton('locator-save-btn', 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å', '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è');
        const exportBtn = createButton('locator-export-btn', 'üì• –≠–∫—Å–ø–æ—Ä—Ç', '–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é');
        const reloadBtn = createButton('locator-reload-btn', 'üîÑ –°–±—Ä–æ—Å', '–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞');
        const closeBtn = createButton('locator-close-btn', '‚úï', '–ó–∞–∫—Ä—ã—Ç—å', 'locator-modal-close');
        
        actionsDiv.appendChild(saveBtn);
        actionsDiv.appendChild(exportBtn);
        actionsDiv.appendChild(reloadBtn);
        actionsDiv.appendChild(closeBtn);
        
        header.appendChild(titleDiv);
        header.appendChild(actionsDiv);
        
        // –°–æ–∑–¥–∞–µ–º body
        const body = document.createElement('div');
        body.className = 'locator-modal-body';
        
        // Sidebar
        const sidebar = document.createElement('aside');
        sidebar.className = 'locator-sidebar';
        sidebar.id = 'locator-keys-list';
        
        const sidebarPlaceholder = document.createElement('div');
        sidebarPlaceholder.className = 'locator-editor-placeholder';
        sidebarPlaceholder.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–∫–∞—Ç–æ—Ä–æ–≤...';
        sidebar.appendChild(sidebarPlaceholder);
        
        // Editor panel
        const editorPanel = document.createElement('section');
        editorPanel.className = 'locator-editor-panel';
        editorPanel.id = 'locator-editor-panel';
        
        const editorPlaceholder = document.createElement('div');
        editorPlaceholder.className = 'locator-editor-placeholder';
        const placeholderText = document.createElement('p');
        placeholderText.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è';
        editorPlaceholder.appendChild(placeholderText);
        editorPanel.appendChild(editorPlaceholder);
        
        body.appendChild(sidebar);
        body.appendChild(editorPanel);
        
        // –°–æ–∑–¥–∞–µ–º footer
        const footer = document.createElement('div');
        footer.className = 'locator-modal-footer';
        
        const statusBar = document.createElement('div');
        statusBar.className = 'locator-status-bar';
        
        const statusText = document.createElement('span');
        statusText.className = 'locator-status-text';
        statusText.id = 'locator-status-text';
        statusText.textContent = '–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ';
        
        statusBar.appendChild(statusText);
        footer.appendChild(statusBar);
        
        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤–º–µ—Å—Ç–µ
        modal.appendChild(header);
        modal.appendChild(body);
        modal.appendChild(footer);
        overlay.appendChild(modal);
        
        console.log('[Locator Editor] –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∞');
        return overlay;
    }
    
    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
     * –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–æ–ø–æ–∫
     * 
     * Args:
     *     id (string): ID –∫–Ω–æ–ø–∫–∏
     *     text (string): –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
     *     title (string): –ü–æ–¥—Å–∫–∞–∑–∫–∞
     *     className (string): –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å
     * 
     * Returns:
     *     HTMLButtonElement: –°–æ–∑–¥–∞–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞
     */
    function createButton(id, text, title, className = 'locator-modal-btn') {
        const button = document.createElement('button');
        button.id = id;
        button.className = className;
        button.title = title;
        button.textContent = text;
        return button;
    }

    /**
     * –í–Ω–µ–¥—Ä–µ–Ω–∏–µ CSS —Å—Ç–∏–ª–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
     * –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å—Ç–∏–ª–∏ –∏–∑ —Ñ–∞–π–ª–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
     */
    function injectStyles() {
        if (document.getElementById('locator-modal-styles')) {
            return;
        }

        const link = document.createElement('link');
        link.id = 'locator-modal-styles';
        link.rel = 'stylesheet';
        link.href = chrome.runtime.getURL('editor.css');
        document.head.appendChild(link);
    }

    /**
     * –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
     * –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
     */
    async function openModal() {
        if (ModalConfig.isOpen) {
            return;
        }

        injectStyles();

        const overlay = createModalHTML();
        document.body.appendChild(overlay);
        
        ModalConfig.isOpen = true;
        document.body.style.overflow = 'hidden';

        attachEventListeners();
        await loadLocatorsForCurrentPage();
    }

    /**
     * –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
     * –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª—è–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
     */
    function closeModal() {
        const overlay = document.getElementById('locator-editor-overlay');
        if (overlay) {
            overlay.remove();
        }

        ModalConfig.isOpen = false;
        document.body.style.overflow = '';
    }

    /**
     * –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
     * –§—É–Ω–∫—Ü–∏—è –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
     */
    function attachEventListeners() {
        const closeBtn = document.getElementById('locator-close-btn');
        const saveBtn = document.getElementById('locator-save-btn');
        const exportBtn = document.getElementById('locator-export-btn');
        const reloadBtn = document.getElementById('locator-reload-btn');
        const overlay = document.getElementById('locator-editor-overlay');

        if (closeBtn) {
            closeBtn.addEventListener('click', closeModal);
        }

        if (saveBtn) {
            saveBtn.addEventListener('click', saveConfiguration);
        }

        if (exportBtn) {
            exportBtn.addEventListener('click', exportConfiguration);
        }

        if (reloadBtn) {
            reloadBtn.addEventListener('click', reloadConfiguration);
        }

        if (overlay) {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeModal();
                }
            });
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && ModalConfig.isOpen) {
                closeModal();
            }
        });
    }

    /**
     * –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–∫–∞—Ç–æ—Ä–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
     * –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–∞–µ—Ç –¥–æ–º–µ–Ω –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ª–æ–∫–∞—Ç–æ—Ä—ã
     */
    async function loadLocatorsForCurrentPage() {
        try {
            updateStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–∫–∞—Ç–æ—Ä–æ–≤...');

            const url = new URL(window.location.href);
            const hostname = url.hostname.replace(/^www\./, '');
            
            ModalConfig.currentDomain = hostname;
            
            const domainElement = document.getElementById('locator-domain-name');
            if (domainElement) {
                domainElement.textContent = `–î–æ–º–µ–Ω: ${hostname}`;
            }

            await loadLocatorsForDomain(hostname);
            
            updateStatus('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', 'success');

        } catch (ex) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–∫–∞—Ç–æ—Ä–æ–≤:', ex);
            updateStatus(`–û—à–∏–±–∫–∞: ${ex.message}`, 'error');
        }
    }

    /**
     * –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ª–æ–∫–∞—Ç–æ—Ä–æ–≤ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞
     * –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç JSON —Ñ–∞–π–ª –ª–æ–∫–∞—Ç–æ—Ä–æ–≤ –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ locators/
     * 
     * Args:
     *     hostname (string): –ò–º—è –¥–æ–º–µ–Ω–∞ –±–µ–∑ www
     */
    async function loadLocatorsForDomain(hostname) {
        try {
            const locatorPath = `locators/${hostname}.json`;
            const locatorUrl = chrome.runtime.getURL(locatorPath);

            const response = await fetch(locatorUrl);

            if (!response.ok) {
                throw new Error(`–§–∞–π–ª –ª–æ–∫–∞—Ç–æ—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω: ${locatorPath}`);
            }

            const config = await response.json();
            
            ModalConfig.currentConfig = JSON.parse(JSON.stringify(config));
            ModalConfig.originalConfig = JSON.parse(JSON.stringify(config));

            renderKeysList();

        } catch (ex) {
            console.error('[Locator Editor] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:', ex);
            
            ModalConfig.currentConfig = {};
            ModalConfig.originalConfig = {};
            
            const keysList = document.getElementById('locator-keys-list');
            if (keysList) {
                keysList.innerHTML = '';
                
                const placeholder = document.createElement('div');
                placeholder.className = 'locator-editor-placeholder';
                placeholder.style.color = '#dc3545';
                placeholder.style.padding = '20px';
                
                const title = document.createElement('p');
                title.style.margin = '0 0 8px 0';
                title.style.fontWeight = '600';
                title.textContent = '–õ–æ–∫–∞—Ç–æ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
                
                const description = document.createElement('p');
                description.style.fontSize = '12px';
                description.style.margin = '0';
                
                const text1 = document.createTextNode('–§–∞–π–ª –ª–æ–∫–∞—Ç–æ—Ä–æ–≤ –¥–ª—è –¥–æ–º–µ–Ω–∞');
                const br1 = document.createElement('br');
                const domain = document.createElement('strong');
                domain.textContent = hostname;
                const br2 = document.createElement('br');
                const text2 = document.createTextNode('–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–∏');
                
                description.appendChild(text1);
                description.appendChild(br1);
                description.appendChild(domain);
                description.appendChild(br2);
                description.appendChild(text2);
                
                placeholder.appendChild(title);
                placeholder.appendChild(description);
                keysList.appendChild(placeholder);
            }
            
            throw ex;
        }
    }

    /**
     * –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–ª—é—á–µ–π –ª–æ–∫–∞—Ç–æ—Ä–æ–≤
     * –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–ª—é—á–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
     */
    function renderKeysList() {
        console.log('[Locator Editor] –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–ª—é—á–µ–π');
        
        const keysList = document.getElementById('locator-keys-list');
        if (!keysList) {
            console.error('[Locator Editor] Keys list –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }

        keysList.innerHTML = '';

        const keys = Object.keys(ModalConfig.currentConfig);

        if (keys.length === 0) {
            const placeholder = document.createElement('div');
            placeholder.className = 'locator-editor-placeholder';
            placeholder.textContent = '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—É—Å—Ç–∞';
            keysList.appendChild(placeholder);
            return;
        }

        keys.forEach(key => {
            const keyItem = document.createElement('div');
            keyItem.className = 'locator-key-item';
            keyItem.textContent = key;
            keyItem.dataset.key = key;
            keyItem.addEventListener('click', () => showEditorForKey(key));
            keysList.appendChild(keyItem);
        });

        updateStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∫–ª—é—á–µ–π: ${keys.length}`, 'success');
        console.log(`[Locator Editor] –û—Ç—Ä–∏—Å–æ–≤–∞–Ω–æ –∫–ª—é—á–µ–π: ${keys.length}`);
    }

    /**
     * –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞
     * –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–µ—Ç —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞ –ª–æ–∫–∞—Ç–æ—Ä–∞
     * 
     * Args:
     *     key (string): –ö–ª—é—á –ª–æ–∫–∞—Ç–æ—Ä–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
     */
    function showEditorForKey(key) {
        console.log(`[Locator Editor] –ü–æ–∫–∞–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –¥–ª—è –∫–ª—é—á–∞: ${key}`);
        
        ModalConfig.activeKey = key;

        document.querySelectorAll('.locator-key-item').forEach(item => {
            item.classList.toggle('active', item.dataset.key === key);
        });

        const data = ModalConfig.currentConfig[key];
        const editorPanel = document.getElementById('locator-editor-panel');
        
        if (!editorPanel) {
            console.error('[Locator Editor] Editor panel –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }

        editorPanel.innerHTML = '';

        const formTitle = document.createElement('h2');
        formTitle.className = 'locator-form-title';
        formTitle.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${key}`;
        editorPanel.appendChild(formTitle);

        const formGrid = document.createElement('div');
        formGrid.className = 'locator-form-grid';

        if (typeof data === 'string') {
            const { label, input } = createInput('value', '–ó–Ω–∞—á–µ–Ω–∏–µ', data, 'text', key);
            formGrid.appendChild(label);
            formGrid.appendChild(input);
        } else {
            // –ú–µ—Ç–æ–¥ –ø–æ–∏—Å–∫–∞
            const byField = createSelect('by', '–ú–µ—Ç–æ–¥ –ø–æ–∏—Å–∫–∞ (By)', data.by, ['XPATH', 'CSS_SELECTOR', 'ID', 'NAME', 'CLASS_NAME', 'TAG_NAME']);
            formGrid.appendChild(byField.label);
            formGrid.appendChild(byField.select);
            
            // –°–µ–ª–µ–∫—Ç–æ—Ä
            const selectorField = createTextArea('selector', '–°–µ–ª–µ–∫—Ç–æ—Ä', data.selector);
            formGrid.appendChild(selectorField.label);
            formGrid.appendChild(selectorField.textarea);
            
            // –ê—Ç—Ä–∏–±—É—Ç
            const attributeField = createInput('attribute', '–ê—Ç—Ä–∏–±—É—Ç', data.attribute, 'text');
            formGrid.appendChild(attributeField.label);
            formGrid.appendChild(attributeField.input);
            
            // –°—Ç—Ä–∞—Ç–µ–≥–∏—è
            const strategyField = createSelect('strategy_for_multiple_selectors', '–°—Ç—Ä–∞—Ç–µ–≥–∏—è', data.strategy_for_multiple_selectors, ['find_first_match', 'find_all_matches']);
            formGrid.appendChild(strategyField.label);
            formGrid.appendChild(strategyField.select);
            
            // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫
            const ifListField = createSelect('if_list', '–ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫', data.if_list, ['first', 'all', 'last']);
            formGrid.appendChild(ifListField.label);
            formGrid.appendChild(ifListField.select);
            
            // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π
            const mandatoryField = createCheckbox('mandatory', '–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π', data.mandatory);
            formGrid.appendChild(mandatoryField.label);
            formGrid.appendChild(mandatoryField.checkbox);
            
            // –û–∂–∏–¥–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç
            const textField = createInput('text_to_be_present_in_element', '–û–∂–∏–¥–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç', data.text_to_be_present_in_element || '', 'text');
            formGrid.appendChild(textField.label);
            formGrid.appendChild(textField.input);
            
            // –°–æ–±—ã—Ç–∏–µ
            const eventField = createInput('event', '–°–æ–±—ã—Ç–∏–µ', data.event || '', 'text');
            formGrid.appendChild(eventField.label);
            formGrid.appendChild(eventField.input);
            
            // –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
            const timeoutEventField = createSelect('timeout_for_event', '–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è', data.timeout_for_event, ['presence_of_element_located', 'element_to_be_clickable', 'visibility_of_element_located']);
            formGrid.appendChild(timeoutEventField.label);
            formGrid.appendChild(timeoutEventField.select);
            
            // –¢–∞–π–º–∞—É—Ç
            const timeoutField = createInput('timeout', '–¢–∞–π–º–∞—É—Ç (—Å–µ–∫)', data.timeout, 'number');
            formGrid.appendChild(timeoutField.label);
            formGrid.appendChild(timeoutField.input);
            
            // –û–ø–∏—Å–∞–Ω–∏–µ
            const descField = createTextArea('locator_description', '–û–ø–∏—Å–∞–Ω–∏–µ', data.locator_description);
            formGrid.appendChild(descField.label);
            formGrid.appendChild(descField.textarea);
        }

        editorPanel.appendChild(formGrid);
        attachFormEventListeners(key);
        updateStatus(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${key}`);
    }

    /**
     * –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
     * –§—É–Ω–∫—Ü–∏—è –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
     * 
     * Args:
     *     parentKey (string): –ö–ª—é—á —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ –ª–æ–∫–∞—Ç–æ—Ä–∞
     */
    function attachFormEventListeners(parentKey) {
        const fields = document.querySelectorAll('[data-field]');
        
        fields.forEach(field => {
            const fieldKey = field.dataset.field;
            const eventType = (field.type === 'checkbox' || field.tagName === 'SELECT') ? 'change' : 'input';

            field.addEventListener(eventType, (e) => {
                let value = e.target.value;
                
                if (e.target.type === 'checkbox') {
                    value = e.target.checked;
                } else if (e.target.type === 'number') {
                    value = parseFloat(value) || 0;
                }

                if (typeof ModalConfig.currentConfig[parentKey] === 'object') {
                    ModalConfig.currentConfig[parentKey][fieldKey] = value;
                } else {
                    ModalConfig.currentConfig[parentKey] = value;
                }

                updateStatus('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∞ (–Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞)', 'error');
            });
        });
    }

    /**
     * –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
     * –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ chrome.storage
     */
    async function saveConfiguration() {
        try {
            updateStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...');

            const storageKey = `locators_${ModalConfig.currentDomain}`;
            await chrome.storage.local.set({ [storageKey]: ModalConfig.currentConfig });

            ModalConfig.originalConfig = JSON.parse(JSON.stringify(ModalConfig.currentConfig));

            const saveBtn = document.getElementById('locator-save-btn');
            if (saveBtn) {
                saveBtn.classList.add('success');
                setTimeout(() => {
                    saveBtn.classList.remove('success');
                }, 2000);
            }

            updateStatus('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');

            setTimeout(() => {
                updateStatus('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', 'success');
            }, 2000);

        } catch (ex) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', ex);
            updateStatus(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${ex.message}`, 'error');
        }
    }

    /**
     * –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ JSON —Ñ–∞–π–ª
     * –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–µ—Ç –∏ —Å–∫–∞—á–∏–≤–∞–µ—Ç JSON —Ñ–∞–π–ª —Å —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
     */
    function exportConfiguration() {
        try {
            const filename = `${ModalConfig.currentDomain}_locators.json`;
            const dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(
                JSON.stringify(ModalConfig.currentConfig, null, 2)
            );
            
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute('href', dataStr);
            downloadAnchorNode.setAttribute('download', filename);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();

            updateStatus('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞', 'success');

        } catch (ex) {
            console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', ex);
            updateStatus(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${ex.message}`, 'error');
        }
    }

    /**
     * –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
     * –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Å—Ö–æ–¥–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
     */
    async function reloadConfiguration() {
        try {
            updateStatus('–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...');

            ModalConfig.currentConfig = JSON.parse(JSON.stringify(ModalConfig.originalConfig));
            
            renderKeysList();
            
            if (ModalConfig.activeKey) {
                showEditorForKey(ModalConfig.activeKey);
            } else {
                const editorPanel = document.getElementById('locator-editor-panel');
                if (editorPanel) {
                    editorPanel.innerHTML = '';
                    
                    const placeholder = document.createElement('div');
                    placeholder.className = 'locator-editor-placeholder';
                    
                    const text = document.createElement('p');
                    text.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è';
                    
                    placeholder.appendChild(text);
                    editorPanel.appendChild(placeholder);
                }
            }

            updateStatus('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');

        } catch (ex) {
            console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏:', ex);
            updateStatus(`–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏: ${ex.message}`, 'error');
        }
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
     * –§—É–Ω–∫—Ü–∏—è –∏–∑–º–µ–Ω—è–µ—Ç —Ç–µ–∫—Å—Ç –∏ —Å—Ç–∏–ª—å —Å—Ç–∞—Ç—É—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
     * 
     * Args:
     *     message (string): –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
     *     type (string): –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è ('success', 'error', '')
     */
    function updateStatus(message, type = '') {
        const statusText = document.getElementById('locator-status-text');
        if (statusText) {
            statusText.textContent = message;
            statusText.className = 'locator-status-text' + (type ? ` ${type}` : '');
        }
    }

    // ============================================================================
    // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ì–ï–ù–ï–†–ê–¶–ò–ò HTML –ü–û–õ–ï–ô
    // ============================================================================

    function createInput(key, labelText, value, type = 'text', parentKey = null) {
        const fieldId = `locator-field-${key}`;
        
        const label = document.createElement('label');
        label.htmlFor = fieldId;
        label.textContent = labelText;
        
        const input = document.createElement('input');
        input.type = type;
        input.id = fieldId;
        input.dataset.field = key;
        if (parentKey) {
            input.dataset.parent = parentKey;
        }
        input.value = value || '';
        
        return { label, input };
    }

    function createTextArea(key, labelText, value) {
        const fieldId = `locator-field-${key}`;
        
        const label = document.createElement('label');
        label.htmlFor = fieldId;
        label.textContent = labelText;
        
        const textarea = document.createElement('textarea');
        textarea.id = fieldId;
        textarea.dataset.field = key;
        textarea.value = value || '';
        
        return { label, textarea };
    }

    function createCheckbox(key, labelText, isChecked) {
        const fieldId = `locator-field-${key}`;
        
        const label = document.createElement('label');
        label.htmlFor = fieldId;
        label.textContent = labelText;
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = fieldId;
        checkbox.dataset.field = key;
        checkbox.checked = isChecked || false;
        
        return { label, checkbox };
    }

    function createSelect(key, labelText, selectedValue, options) {
        const fieldId = `locator-field-${key}`;
        
        const label = document.createElement('label');
        label.htmlFor = fieldId;
        label.textContent = labelText;
        
        const select = document.createElement('select');
        select.id = fieldId;
        select.dataset.field = key;
        
        options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt;
            option.textContent = opt;
            if (opt === selectedValue) {
                option.selected = true;
            }
            select.appendChild(option);
        });
        
        return { label, select };
    }

    // –°–ª—É—à–∞—Ç–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç background script
    chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
        if (request.action === 'openLocatorModal') {
            openModal();
            sendResponse({ status: 'ok' });
        }
        return true;
    });

    console.log('Locator Modal Content Script loaded');
})();
